#!/usr/bin/env tclsh8.6
# -*- mode: tcl; indent-tabs-mode: nil; tab-width: 4; -*-

package require appc::native
package require appc::build
package require appc::run

#appc --empty 1 --basejail zroot/jails/base
#appc build [-f {tclscript}]
#Check if base jail exists if not create from pool and
# pull down tarball and extract
set options [appc::parse_options $argv]

set command [dict get $options command]

switch -exact $command {

    build {
        appc::build::build_command [dict get $options args]
    }
    run {
        appc::run::run_command [dict get $options args]
    }
}
#Notes on appc build
# - We will pull down the "FROM" images into a special jail for building the image
# - We commands will be executed in that jail
# - The jail is created and deleted for each "build" invocation

#initialize basejail to commandline
# set basejail $::appc::_::basejail_snapshot
# set appc_dataset $::appc::_::appc_dataset
# set mountpoint [pwd]/mnt
# set jailname {testjail}
# if {[dict exists $::appc::_::zfs_snapshots $basejail]} {

#     puts stderr "Exists.. cloning"

#     #TODO: Where to mount?  Maybe: ~/.appc/mounts/<jailname>
#     ::appc::_::zfs_clone_snapshot $basejail [join "$appc_dataset $jailname" /] $mountpoint
# }

# ::appc::_::jail_start $mountpoint {/bin/sh}

#TODO: I probably need an appc pool to manage
#if basejail is a snapshot clone it
#if basejail is not a snapshot but exists, snapshot it
#if basejail is not a snapshot and does not exist create it from pool specified
# in first part of dataset path by creating the dataset,
# pulling down base.tar.gz and untar'ing it.

